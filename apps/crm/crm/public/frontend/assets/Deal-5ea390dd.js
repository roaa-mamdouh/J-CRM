import{a as Me}from"./FadedScrollableDiv-9739b5b1.js";import{_ as Te,a as Ee}from"./SidePanelModal-38441ea1.js";import{u as Re,_ as Be,A as Ne,E as Le,a as ie,b as je,S as qe,L as Oe}from"./useActiveTabManager-d63d67a2.js";import{_ as Fe,E as Pe}from"./views-29c7636e.js";import{E as re}from"./Email2Icon-114a3543.js";import{C as We}from"./CommentIcon-552fbe88.js";import{P as H}from"./PhoneIcon-206b2bf3.js";import{T as Ge}from"./TaskIcon-a509cbac.js";import{N as He}from"./NoteModal-ee3b9103.js";import{W as Ke}from"./WhatsAppIcon-c40bbe0a.js";import{I as Je}from"./IndicatorIcon-4dd9059c.js";import{L as Qe}from"./LinkIcon-4bbaca23.js";import{A as Xe}from"./ArrowUpRightIcon-1f7d0656.js";import{g as Ye,_ as Ze,S as ea,a as aa}from"./view-2824ccd2.js";import{_ as ta}from"./LayoutHeader-1f47b812.js";import{_ as oa}from"./OrganizationModal-1216d9a3.js";import{_ as sa}from"./AssignmentModal-b1255d73.js";import{s as la,_ as na}from"./statuses-7de18649.js";import{C as ia}from"./ContactModal-4e6a6471.js";import{_ as de}from"./Section-8b41410b.js";import{_ as ra}from"./CustomActions-4aa71942.js";import{g as da,u as ma,e as x,s as ua,i as ca,j as pa,_ as $,b as me,k as R,o as _a}from"./index-79582337.js";import{c as ue,w as fa}from"./settings-76fff180.js";import{_ as va,h as ga,v as ya,l as v,x as U,I as A,a as ba,o as ha,j as ce,K as xa,r as K,b as d,c as _,u as t,g as f,w as n,p as c,d as o,L as J,F as Q,G as Ca,n as B,e as u,t as w,f as pe,H as _e,B as wa}from"./index-94cddbf2.js";import{_ as ka}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-ac4cff83.js";import{_ as fe}from"./Dropdown.vue_vue_type_script_setup_true_lang-f30ca23a.js";import"./DragVerticalIcon-2b8c1048.js";import"./Switch.vue_vue_type_script_setup_true_lang-34bdad39.js";import"./CalendarIcon-64a87471.js";import"./callLog-4af9dda9.js";import"./contacts-945ac9fb.js";import"./IconPicker-43902fe0.js";import"./FileUploader-22e9b494.js";import"./LeadsIcon-86dc61b1.js";import"./DealsIcon-c75ef9a8.js";import"./EmailTemplateModal-8c6fb82c.js";import"./TaskModal-d3bb0e4f.js";import"./Fields-0a7d93b5.js";import"./DatePicker.vue_vue_type_script_setup_true_lang-3cf9a372.js";import"./AddressModal-c9e0b8b2.js";import"./QuickEntryModal-c9cc5254.js";import"./WebsiteIcon-612bfcb9.js";import"./OrganizationsIcon-18979377.js";const Ia={key:1,class:"flex h-full overflow-hidden"},Va={class:"flex items-center justify-start gap-5 border-b p-5"},za={class:"group relative size-12"},$a={class:"flex flex-col gap-2.5 truncate"},Da={class:"truncate text-2xl font-medium"},Sa={class:"flex gap-1.5"},Ua={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Aa={class:"flex flex-col overflow-y-auto"},Ma={key:0,class:"pr-2"},Ta={key:1},Ea={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},Ra={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},Ba=["onClick"],Na={class:"truncate"},La={class:"flex items-center"},ja={class:"flex flex-col gap-1.5 text-base text-gray-800"},qa={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Oa={class:"flex items-center gap-3 p-1 py-1.5"},Fa={key:0,class:"mx-2 h-px border-t border-gray-200"},Pa={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},Wa={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(ve){const{$dialog:ge,$socket:N,makeCall:ye}=da(),{statusOptions:be,getDealStatus:he}=la(),{isManager:xe}=ma(),k=ga(),M=ya(),g=ve,L=v([]),X=v([]),l=U({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:g.dealId},cache:["deal",g.dealId],onSuccess:async a=>{a.organization&&(b.update({params:{doctype:"CRM Organization",name:a.organization}}),b.fetch());let e={doc:a,$dialog:ge,$socket:N,router:M,updateField:D,createToast:x,deleteDoc:Se,resource:{deal:l,dealContacts:y,fieldsLayout:V},call:A};ua(a);let i=await ca(a,e);L.value=i.actions||[],X.value=i.statuses||[]}}),b=U({url:"frappe.client.get",onSuccess:a=>l.data._organizationObj=a});ba(()=>{if(N.on("crm_customer_created",()=>{x({title:__("Customer created successfully"),icon:"check",iconClasses:"text-green-600"})}),l.data){b.data=l.data._organizationObj;return}l.fetch()}),ha(()=>{N.off("crm_customer_created")});const j=v(!1),q=v(!1),T=v(!1),E=v(!1),O=v(!1),F=v({});function Ce(a,e,i){e=Array.isArray(a)?"":e,!we(a,e)&&U({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:g.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{l.reload(),j.value=!0,x({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),i==null||i()},onError:m=>{var z;x({title:__("Error updating deal"),text:__((z=m.messages)==null?void 0:z[0]),icon:"x",iconClasses:"text-red-600"})}})}function we(a,e){var m;let i=l.data.fields_meta||{};return(m=i[a])!=null&&m.reqd&&!e?(x({title:__("Error Updating Deal"),text:__("{0} is a required field",[i[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const ke=ce(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];if(k.query.view||k.query.viewType){let i=Ye(k.query.view,k.query.viewType,"CRM Deal");i&&a.push({label:__(i.label),icon:i.icon,route:{name:"Deals",params:{viewType:k.query.viewType},query:{view:k.query.view}}})}return a.push({label:((e=b.data)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:l.data.name}}}),a});xa(()=>{var a,e;return{title:((a=b.data)==null?void 0:a.name)||((e=l.data)==null?void 0:e.name)}});const P=ce(()=>[{name:"Activity",label:__("Activity"),icon:Ne},{name:"Emails",label:__("Emails"),icon:Le},{name:"Comments",label:__("Comments"),icon:We},{name:"Calls",label:__("Calls"),icon:H,condition:()=>ue.value},{name:"Tasks",label:__("Tasks"),icon:Ge},{name:"Notes",label:__("Notes"),icon:He},{name:"Attachments",label:__("Attachments"),icon:ie},{name:"WhatsApp",label:__("WhatsApp"),icon:Ke,condition:()=>fa.value}].filter(e=>e.condition?e.condition():!0)),{tabIndex:I}=Re(P,"lastDealTab"),V=U({url:"crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",g.dealId],params:{doctype:"CRM Deal",name:g.dealId},auto:!0,transform:a=>Ie(a)});function Ie(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(i=>{i.name=="organization"&&(i.create=(m,z)=>{F.value.organization_name=m,q.value=!0,z()},i.link=m=>M.push({name:"Organization",params:{organizationId:m}}))})}),a}const W=v(!1),Y=v({});function Ve(a){let e=[{label:__("Remove"),icon:"trash-2",onClick:()=>ze(a.name)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:wa(aa,{class:"h-4 w-4"}),onClick:()=>$e(a.name)}),e}async function Z(a){await A("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:g.dealId,contact:a})&&(y.reload(),x({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function ze(a){await A("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:g.dealId,contact:a})&&(y.reload(),x({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function $e(a){await A("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:g.dealId,contact:a})&&(y.reload(),x({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const y=U({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:g.dealId},cache:["deal_contacts",g.dealId],auto:!0,transform:a=>(a.forEach(e=>{e.opened=!1}),a)});function De(){var i;let a=(i=y.data)==null?void 0:i.find(m=>m.is_primary),e=a.mobile_no||null;if(!a){R(__("No primary contact set"));return}if(!e){R(__("No mobile number set"));return}ye(e)}function D(a,e,i){Ce(a,e,()=>{l.data[a]=e,i==null||i()})}async function Se(a){await A("frappe.client.delete",{doctype:"CRM Deal",name:a}),M.push({name:"Deals"})}const G=v(null);function Ue(){G.value.emailBox.show=!0}return(a,e)=>{var ee;const i=K("FeatherIcon"),m=K("Button"),z=K("Badge");return d(),_(Q,null,[t(l).data?(d(),f(ta,{key:0},{"left-header":n(()=>[o(t(ka),{items:ke.value},{prefix:n(({item:s})=>[s.icon?(d(),f(Me,{key:0,icon:s.icon,class:"mr-2 h-4"},null,8,["icon"])):c("",!0)]),_:1},8,["items"])]),"right-header":n(()=>{var s;return[L.value?(d(),f(ra,{key:0,actions:L.value},null,8,["actions"])):c("",!0),(d(),f(Ca(((s=t(l).data._assignedTo)==null?void 0:s.length)==1?"Button":"div"),null,{default:n(()=>[o(na,{avatars:t(l).data._assignedTo,onClick:e[0]||(e[0]=r=>T.value=!0)},null,8,["avatars"])]),_:1})),o(t(fe),{options:t(be)("deal",D,X.value)},{default:n(({open:r})=>[o(m,{label:t(l).data.status,class:B(t(he)(t(l).data.status).colorClass)},{prefix:n(()=>[o(Je)]),suffix:n(()=>[o(i,{name:r?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):c("",!0),t(l).data?(d(),_("div",Ia,[o(t(Ze),{modelValue:t(I),"onUpdate:modelValue":e[4]||(e[4]=s=>J(I)?I.value=s:null),tabs:P.value},{default:n(()=>[o(je,{ref_key:"activities",ref:G,doctype:"CRM Deal",tabs:P.value,reload:j.value,"onUpdate:reload":e[1]||(e[1]=s=>j.value=s),tabIndex:t(I),"onUpdate:tabIndex":e[2]||(e[2]=s=>J(I)?I.value=s:null),modelValue:t(l),"onUpdate:modelValue":e[3]||(e[3]=s=>J(l)?l.value=s:null)},null,8,["tabs","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(Te,{side:"right",class:"flex flex-col justify-between border-l"},{default:n(()=>{var s;return[u("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=r=>t(pa)(t(l).data.name))},w(a.__(t(l).data.name)),1),u("div",Va,[o(t($),{text:a.__("Organization logo")},{default:n(()=>{var r,C;return[u("div",za,[o(t(me),{size:"3xl",class:"size-12",label:((r=t(b).data)==null?void 0:r.name)||a.__("Untitled"),image:(C=t(b).data)==null?void 0:C.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),u("div",$a,[o(t($),{text:((s=t(b).data)==null?void 0:s.name)||a.__("Set an organization")},{default:n(()=>{var r;return[u("div",Da,w(((r=t(b).data)==null?void 0:r.name)||a.__("Untitled")),1)]}),_:1},8,["text"]),u("div",Sa,[t(ue)?(d(),f(t($),{key:0,text:a.__("Make a call")},{default:n(()=>[o(m,{class:"h-7 w-7",onClick:De},{default:n(()=>[o(H,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):c("",!0),o(t($),{text:a.__("Send an email")},{default:n(()=>[o(m,{class:"h-7 w-7"},{default:n(()=>[o(re,{class:"h-4 w-4",onClick:e[6]||(e[6]=r=>t(l).data.email?Ue():t(R)(a.__("No email set")))})]),_:1})]),_:1},8,["text"]),o(t($),{text:a.__("Go to website")},{default:n(()=>[o(m,{class:"h-7 w-7"},{default:n(()=>[o(Qe,{class:"h-4 w-4",onClick:e[7]||(e[7]=r=>t(l).data.website?t(_a)(t(l).data.website):t(R)(a.__("No website set")))})]),_:1})]),_:1},8,["text"]),o(t($),{text:a.__("Attach a file")},{default:n(()=>[o(m,{class:"size-7",onClick:e[8]||(e[8]=r=>O.value=!0)},{default:n(()=>[o(ie,{class:"size-4"})]),_:1})]),_:1},8,["text"])])])]),t(l).data.sla_status?(d(),f(qe,{key:0,modelValue:t(l).data,"onUpdate:modelValue":e[9]||(e[9]=r=>t(l).data=r),onUpdateField:D},null,8,["modelValue"])):c("",!0),t(V).data?(d(),_("div",Ua,[u("div",Aa,[(d(!0),_(Q,null,pe(t(V).data,(r,C)=>(d(),_("div",{key:r.label,class:B(["section flex flex-col p-3",{"border-b":C!==t(V).data.length-1}])},[o(de,{"is-opened":r.opened,label:r.label},{actions:n(()=>[r.contacts?(d(),_("div",Ma,[o(Fe,{value:"",doctype:"Contact",onChange:e[10]||(e[10]=h=>Z(h)),onCreate:(h,S)=>{Y.value={first_name:h,company_name:t(l).data.organization},W.value=!0,S()}},{target:n(({togglePopover:h})=>[o(m,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:S=>h()},null,8,["onClick"])]),_:1},8,["onCreate"])])):(!r.contacts&&C==1||C==0)&&t(xe)()?(d(),f(m,{key:1,variant:"ghost",class:"w-7 mr-2",onClick:e[11]||(e[11]=h=>E.value=!0)},{default:n(()=>[o(Pe,{class:"h-4 w-4"})]),_:1})):c("",!0)]),default:n(()=>{var h,S,ae,te,oe;return[r.fields?(d(),f(ea,{key:0,fields:r.fields,isLastSection:C==t(V).data.length-1,modelValue:t(l).data,"onUpdate:modelValue":e[12]||(e[12]=p=>t(l).data=p),onUpdate:D},null,8,["fields","isLastSection","modelValue"])):(d(),_("div",Ta,[(h=t(y))!=null&&h.loading&&((ae=(S=t(y))==null?void 0:S.data)==null?void 0:ae.length)==0?(d(),_("div",Ea,[o(Oe,{class:"h-4 w-4"}),u("span",null,w(a.__("Loading...")),1)])):(oe=(te=t(y))==null?void 0:te.data)!=null&&oe.length?(d(!0),_(Q,{key:1},pe(t(y).data,(p,se)=>(d(),_("div",{key:p.name},[u("div",{class:B(["px-2 pb-2.5",[se==0?"pt-5":"pt-2.5"]])},[o(de,{"is-opened":p.opened},{header:n(({opened:Ae,toggle:le})=>[u("div",Ra,[u("div",{class:"flex h-7 items-center gap-2 truncate",onClick:ne=>le()},[o(t(me),{label:p.full_name,image:p.image,size:"md"},null,8,["label","image"]),u("div",Na,w(p.full_name),1),p.is_primary?(d(),f(z,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):c("",!0)],8,Ba),u("div",La,[o(t(fe),{options:Ve(p)},{default:n(()=>[o(m,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),o(m,{variant:"ghost",onClick:ne=>t(M).push({name:"Contact",params:{contactId:p.name}})},{default:n(()=>[o(Xe,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(m,{variant:"ghost",onClick:ne=>le()},{default:n(()=>[o(i,{name:"chevron-right",class:B(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":Ae}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:n(()=>[u("div",ja,[u("div",qa,[o(re,{class:"h-4 w-4"}),_e(" "+w(p.email),1)]),u("div",Oa,[o(H,{class:"h-4 w-4"}),_e(" "+w(p.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),se!=t(y).data.length-1?(d(),_("div",Fa)):c("",!0)]))),128)):(d(),_("div",Pa,w(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):c("",!0)]}),_:1})])):c("",!0),o(oa,{modelValue:q.value,"onUpdate:modelValue":e[13]||(e[13]=s=>q.value=s),organization:F.value,"onUpdate:organization":e[14]||(e[14]=s=>F.value=s),options:{redirect:!1,afterInsert:s=>D("organization",s.name)}},null,8,["modelValue","organization","options"]),o(ia,{modelValue:W.value,"onUpdate:modelValue":e[15]||(e[15]=s=>W.value=s),contact:Y.value,options:{redirect:!1,afterInsert:s=>Z(s.name)}},null,8,["modelValue","contact","options"]),T.value?(d(),f(sa,{key:2,modelValue:T.value,"onUpdate:modelValue":e[16]||(e[16]=s=>T.value=s),assignees:t(l).data._assignedTo,"onUpdate:assignees":e[17]||(e[17]=s=>t(l).data._assignedTo=s),doc:t(l).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):c("",!0),E.value?(d(),f(Ee,{key:3,modelValue:E.value,"onUpdate:modelValue":e[18]||(e[18]=s=>E.value=s),doctype:"CRM Deal",onReload:e[19]||(e[19]=()=>t(V).reload())},null,8,["modelValue"])):c("",!0),(ee=t(l).data)!=null&&ee.name?(d(),f(Be,{key:4,modelValue:O.value,"onUpdate:modelValue":e[20]||(e[20]=s=>O.value=s),doctype:"CRM Deal",docname:t(l).data.name,onAfter:e[21]||(e[21]=()=>{var s,r;(r=(s=G.value)==null?void 0:s.all_activities)==null||r.reload(),a.changeTabTo("attachments")})},null,8,["modelValue","docname"])):c("",!0)],64)}}},Et=va(Wa,[["__scopeId","data-v-418e4093"]]);export{Et as default};
//# sourceMappingURL=Deal-5ea390dd.js.map
