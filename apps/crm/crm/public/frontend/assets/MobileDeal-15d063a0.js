import{a as ye}from"./FadedScrollableDiv-9739b5b1.js";import{D as he}from"./DetailsIcon-24bf3ae4.js";import{u as be,A as xe,E as Ce,a as we,S as Ie,L as ke,b as De}from"./useActiveTabManager-d63d67a2.js";import{E as Ve}from"./Email2Icon-114a3543.js";import{C as ze}from"./CommentIcon-552fbe88.js";import{P as Y}from"./PhoneIcon-206b2bf3.js";import{T as Se}from"./TaskIcon-a509cbac.js";import{N as $e}from"./NoteModal-ee3b9103.js";import{W as Ae}from"./WhatsAppIcon-c40bbe0a.js";import{I as Te}from"./IndicatorIcon-4dd9059c.js";import{A as Ue}from"./ArrowUpRightIcon-1f7d0656.js";import{g as Me,S as Ee,_ as Re,a as qe}from"./view-2824ccd2.js";import{_ as Be}from"./LayoutHeader-1f47b812.js";import{_ as Le}from"./OrganizationModal-1216d9a3.js";import{_ as je}from"./AssignmentModal-b1255d73.js";import{s as Ne,_ as Fe}from"./statuses-7de18649.js";import{C as Oe}from"./ContactModal-4e6a6471.js";import{_ as Pe}from"./views-29c7636e.js";import{_ as Z}from"./Section-8b41410b.js";import{_ as We}from"./CustomActions-4aa71942.js";import{g as Ge,e as h,s as He,i as Je,b as Ke}from"./index-79582337.js";import{i as Qe,c as Xe,w as Ye}from"./settings-76fff180.js";import{h as Ze,v as ea,l as y,x as V,I as z,a as aa,j as ee,r as j,b as i,c as m,u as t,g as v,w as c,p as _,G as ta,e as u,d as r,L as N,F,n as T,f as ae,t as S,H as te,B as oa}from"./index-94cddbf2.js";import{_ as sa}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-ac4cff83.js";import{_ as oe}from"./Dropdown.vue_vue_type_script_setup_true_lang-f30ca23a.js";import"./CalendarIcon-64a87471.js";import"./callLog-4af9dda9.js";import"./contacts-945ac9fb.js";import"./IconPicker-43902fe0.js";import"./FileUploader-22e9b494.js";import"./LeadsIcon-86dc61b1.js";import"./DealsIcon-c75ef9a8.js";import"./EmailTemplateModal-8c6fb82c.js";import"./TaskModal-d3bb0e4f.js";import"./Fields-0a7d93b5.js";import"./DatePicker.vue_vue_type_script_setup_true_lang-3cf9a372.js";import"./AddressModal-c9e0b8b2.js";import"./QuickEntryModal-c9cc5254.js";import"./DragVerticalIcon-2b8c1048.js";import"./Switch.vue_vue_type_script_setup_true_lang-34bdad39.js";import"./WebsiteIcon-612bfcb9.js";import"./OrganizationsIcon-18979377.js";const na={class:"relative flex h-10.5 items-center justify-between gap-2 py-2.5 pl-2"},la={class:"absolute right-0"},ia={key:1,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},ra={class:"flex items-center gap-2"},da={key:2,class:"flex h-full overflow-hidden"},ca={key:0},ma={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},ua={class:"flex flex-col overflow-y-auto"},pa={key:0,class:"pr-2"},_a={key:1},fa={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},va={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},ga=["onClick"],ya={class:"truncate"},ha={class:"flex items-center"},ba={class:"flex flex-col gap-1.5 text-base text-gray-800"},xa={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Ca={class:"flex items-center gap-3 p-1 py-1.5"},wa={key:0,class:"mx-2 h-px border-t border-gray-200"},Ia={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},pt={__name:"MobileDeal",props:{dealId:{type:String,required:!0}},setup(se){const{$dialog:ne,$socket:le}=Ge(),{statusOptions:ie,getDealStatus:re}=Ne(),b=Ze(),$=ea(),f=se,U=y([]),O=y([]),o=V({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:f.dealId},cache:["deal",f.dealId],onSuccess:async a=>{a.organization&&(M.update({params:{doctype:"CRM Organization",name:a.organization}}),M.fetch());let e={doc:a,$dialog:ne,$socket:le,router:$,updateField:k,createToast:h,deleteDoc:ve,resource:{deal:o,dealContacts:w,fieldsLayout:C},call:z};He(a);let s=await Je(a,e);U.value=s.actions||[],O.value=s.statuses||[]}}),M=V({url:"frappe.client.get",onSuccess:a=>o.data._organizationObj=a});aa(()=>{o.data||o.fetch()});const E=y(!1),R=y(!1),A=y(!1),q=y({});function de(a,e,s){e=Array.isArray(a)?"":e,!ce(a,e)&&V({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:f.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{o.reload(),E.value=!0,h({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),s==null||s()},onError:n=>{var I;h({title:__("Error updating deal"),text:__((I=n.messages)==null?void 0:I[0]),icon:"x",iconClasses:"text-red-600"})}})}function ce(a,e){var n;let s=o.data.fields_meta||{};return(n=s[a])!=null&&n.reqd&&!e?(h({title:__("Error Updating Deal"),text:__("{0} is a required field",[s[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const me=ee(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];if(b.query.view||b.query.viewType){let s=Me(b.query.view,b.query.viewType,"CRM Deal");s&&a.push({label:__(s.label),icon:s.icon,route:{name:"Deals",params:{viewType:b.query.viewType},query:{view:b.query.view}}})}return a.push({label:((e=M.data)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:o.data.name}}}),a}),B=ee(()=>[{name:"Details",label:__("Details"),icon:he,condition:()=>Qe.value},{name:"Activity",label:__("Activity"),icon:xe},{name:"Emails",label:__("Emails"),icon:Ce},{name:"Comments",label:__("Comments"),icon:ze},{name:"Calls",label:__("Calls"),icon:Y,condition:()=>Xe.value},{name:"Tasks",label:__("Tasks"),icon:Se},{name:"Notes",label:__("Notes"),icon:$e},{name:"Attachments",label:__("Attachments"),icon:we},{name:"WhatsApp",label:__("WhatsApp"),icon:Ae,condition:()=>Ye.value}].filter(e=>e.condition?e.condition():!0)),{tabIndex:x}=be(B,"lastDealTab"),C=V({url:"crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",f.dealId],params:{doctype:"CRM Deal",name:f.dealId},auto:!0,transform:a=>ue(a)});function ue(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(s=>{s.name=="organization"&&(s.create=(n,I)=>{q.value.organization_name=n,R.value=!0,I()},s.link=n=>$.push({name:"Organization",params:{organizationId:n}}))})}),a}const L=y(!1),P=y({});function pe(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>_e(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:oa(qe,{class:"h-4 w-4"}),onClick:()=>fe(a.name)}),e}async function W(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:f.dealId,contact:a})&&(w.reload(),h({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function _e(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:f.dealId,contact:a})&&(w.reload(),h({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function fe(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:f.dealId,contact:a})&&(w.reload(),h({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const w=V({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:f.dealId},cache:["deal_contacts",f.dealId],auto:!0,onSuccess:a=>{var s;let e=(s=C.data)==null?void 0:s.find(n=>n.name=="contacts_section");e&&(e.contacts=a.map(n=>({name:n.name,full_name:n.full_name,email:n.email,mobile_no:n.mobile_no,image:n.image,is_primary:n.is_primary,opened:!1})))}});function k(a,e,s){de(a,e,()=>{o.data[a]=e,s==null||s()})}async function ve(a){await z("frappe.client.delete",{doctype:"CRM Deal",name:a}),$.push({name:"Deals"})}return(a,e)=>{var G;const s=j("FeatherIcon"),n=j("Button"),I=j("Badge");return i(),m(F,null,[t(o).data?(i(),v(Be,{key:0},{default:c(()=>[u("header",na,[r(t(sa),{items:me.value},{prefix:c(({item:l})=>[l.icon?(i(),v(ye,{key:0,icon:l.icon,class:"mr-2 h-4"},null,8,["icon"])):_("",!0)]),_:1},8,["items"]),u("div",la,[r(t(oe),{options:t(ie)("deal",k,O.value)},{default:c(({open:l})=>[r(n,{label:t(o).data.status,class:T(t(re)(t(o).data.status).colorClass)},{prefix:c(()=>[r(Te)]),suffix:c(()=>[r(s,{name:l?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])])])]),_:1})):_("",!0),t(o).data?(i(),m("div",ia,[(i(),v(ta(((G=t(o).data._assignedTo)==null?void 0:G.length)==1?"Button":"div"),null,{default:c(()=>[r(Fe,{avatars:t(o).data._assignedTo,onClick:e[0]||(e[0]=l=>A.value=!0)},null,8,["avatars"])]),_:1})),u("div",ra,[U.value?(i(),v(We,{key:0,actions:U.value},null,8,["actions"])):_("",!0)])])):_("",!0),t(o).data?(i(),m("div",da,[r(t(Re),{modelValue:t(x),"onUpdate:modelValue":e[7]||(e[7]=l=>N(x)?x.value=l:null),tabs:B.value,tablistClass:"!px-3",class:"overflow-auto"},{default:c(({tab:l})=>[l.name=="Details"?(i(),m("div",ca,[t(o).data.sla_status?(i(),v(Ie,{key:0,modelValue:t(o).data,"onUpdate:modelValue":e[1]||(e[1]=d=>t(o).data=d),onUpdateField:k},null,8,["modelValue"])):_("",!0),t(C).data?(i(),m("div",ma,[u("div",ua,[(i(!0),m(F,null,ae(t(C).data,(d,H)=>(i(),m("div",{key:d.label,class:T(["flex flex-col px-2 py-3 sm:p-3",{"border-b":H!==t(C).data.length-1}])},[r(Z,{"is-opened":d.opened,label:d.label},{actions:c(()=>[d.contacts?(i(),m("div",pa,[r(Pe,{value:"",doctype:"Contact",onChange:e[2]||(e[2]=g=>W(g)),onCreate:(g,D)=>{P.value={first_name:g,company_name:t(o).data.organization},L.value=!0,D()}},{target:c(({togglePopover:g})=>[r(n,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:D=>g()},null,8,["onClick"])]),_:1},8,["onCreate"])])):_("",!0)]),default:c(()=>{var g,D,J;return[d.fields?(i(),v(Ee,{key:0,fields:d.fields,isLastSection:H==t(C).data.length-1,modelValue:t(o).data,"onUpdate:modelValue":e[3]||(e[3]=p=>t(o).data=p),onUpdate:k},null,8,["fields","isLastSection","modelValue"])):(i(),m("div",_a,[(g=t(w))!=null&&g.loading&&((J=(D=t(w))==null?void 0:D.data)==null?void 0:J.length)==0?(i(),m("div",fa,[r(ke,{class:"h-4 w-4"}),u("span",null,S(a.__("Loading...")),1)])):d.contacts.length?(i(!0),m(F,{key:1},ae(d.contacts,(p,K)=>(i(),m("div",{key:p.name},[u("div",{class:T(["px-2 pb-2.5",[K==0?"pt-5":"pt-2.5"]])},[r(Z,{"is-opened":p.opened},{header:c(({opened:ge,toggle:Q})=>[u("div",va,[u("div",{class:"flex h-7 items-center gap-2 truncate",onClick:X=>Q()},[r(t(Ke),{label:p.full_name,image:p.image,size:"md"},null,8,["label","image"]),u("div",ya,S(p.full_name),1),p.is_primary?(i(),v(I,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):_("",!0)],8,ga),u("div",ha,[r(t(oe),{options:pe(p.name)},{default:c(()=>[r(n,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),r(n,{variant:"ghost",onClick:X=>t($).push({name:"Contact",params:{contactId:p.name}})},{default:c(()=>[r(Ue,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),r(n,{variant:"ghost",onClick:X=>Q()},{default:c(()=>[r(s,{name:"chevron-right",class:T(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":ge}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:c(()=>[u("div",ba,[u("div",xa,[r(Ve,{class:"h-4 w-4"}),te(" "+S(p.email),1)]),u("div",Ca,[r(Y,{class:"h-4 w-4"}),te(" "+S(p.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),K!=d.contacts.length-1?(i(),m("div",wa)):_("",!0)]))),128)):(i(),m("div",Ia,S(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):_("",!0)])):(i(),v(De,{key:1,doctype:"CRM Deal",tabs:B.value,reload:E.value,"onUpdate:reload":e[4]||(e[4]=d=>E.value=d),tabIndex:t(x),"onUpdate:tabIndex":e[5]||(e[5]=d=>N(x)?x.value=d:null),modelValue:t(o),"onUpdate:modelValue":e[6]||(e[6]=d=>N(o)?o.value=d:null)},null,8,["tabs","reload","tabIndex","modelValue"]))]),_:1},8,["modelValue","tabs"])])):_("",!0),r(Le,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=l=>R.value=l),organization:q.value,"onUpdate:organization":e[9]||(e[9]=l=>q.value=l),options:{redirect:!1,afterInsert:l=>k("organization",l.name)}},null,8,["modelValue","organization","options"]),r(Oe,{modelValue:L.value,"onUpdate:modelValue":e[10]||(e[10]=l=>L.value=l),contact:P.value,options:{redirect:!1,afterInsert:l=>W(l.name)}},null,8,["modelValue","contact","options"]),A.value?(i(),v(je,{key:3,modelValue:A.value,"onUpdate:modelValue":e[11]||(e[11]=l=>A.value=l),assignees:t(o).data._assignedTo,"onUpdate:assignees":e[12]||(e[12]=l=>t(o).data._assignedTo=l),doc:t(o).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):_("",!0)],64)}}};export{pt as default};
//# sourceMappingURL=MobileDeal-15d063a0.js.map
